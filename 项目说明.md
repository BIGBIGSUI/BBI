# Nintendo Switch MTP项目说明

## 项目简介

这是一个基于原始usbhs示例改装的MTP (Media Transfer Protocol) 项目，集成了sphaira的MTP功能。通过本项目，你可以将Nintendo Switch通过USB连接到电脑，像访问普通移动设备一样浏览和管理Switch的文件系统。

## 主要功能

### 操作方式
- **X键**: 启动MTP服务
- **B键**: 停止MTP服务  
- **+键**: 退出程序

### 可访问的存储设备
1. **microSD card** - Switch的microSD卡（所有游戏数据、截图、视频等）
2. **Image nand** - Switch的NAND分区（系统游戏安装位置）

## 编译环境要求

### 必需软件
1. **DevkitPro** - Nintendo Switch开发工具链
2. **libnx** - Nintendo Switch开发库
3. **libhaze** - MTP协议实现库

### 安装libhaze

在DevkitPro的MSYS2环境中执行：
```bash
pacman -S switch-libhaze
```

如果官方源没有libhaze，可以手动编译安装：
```bash
git clone https://github.com/ITotalJustice/libhaze.git
cd libhaze
make
make install
```

## 编译步骤

### Windows环境

1. 打开DevkitPro的MSYS2终端
2. 进入项目目录：
   ```bash
   cd /home/24289/mtp/usbhs
   ```
3. 编译项目：
   ```bash
   make clean
   make
   ```

### 使用编译脚本

也可以使用提供的编译脚本：
```bash
chmod +x build.sh
./build.sh
```

## 安装和使用

### 安装到Switch

1. 编译成功后会生成 `mtp.nro` 文件
2. 将SD卡连接到电脑
3. 创建目录 `/switch/mtp/`（如果不存在）
4. 复制 `mtp.nro` 到 `/switch/mtp/` 目录

### 在Switch上运行

1. 启动Homebrew Launcher（通过相册或游戏等入口）
2. 找到并运行 `mtp` 应用
3. 按 **X键** 启动MTP服务
4. 使用USB-C数据线连接Switch和电脑
5. 电脑会识别出Switch作为MTP设备

### 在电脑上访问文件

**Windows 10/11:**
- 打开"此电脑"，应该会看到Switch设备
- 双击打开可以看到两个存储位置
- 直接拖拽文件即可传输

**macOS:**
- 需要安装第三方MTP软件，如Android File Transfer
- 或使用OpenMTP等工具

**Linux:**
- 确保安装了libmtp和相关工具
- 可以使用文件管理器直接访问
- 或使用命令行工具如 `mtp-tools`

## 常见问题

### Q: 编译时出现 "haze.h: No such file or directory" 错误
**A:** 需要安装libhaze库：
```bash
pacman -S switch-libhaze
```

### Q: 按X后显示"Failed to initialize"
**A:** 可能的原因：
- USB端口被其他程序占用
- 需要重启Switch后再试
- libhaze库版本不兼容

### Q: 电脑无法识别Switch设备
**A:** 解决方法：
1. 确认已按X键启动MTP服务
2. 更换USB数据线（确保是数据线不是充电线）
3. 更换USB端口（优先使用USB 3.0端口）
4. Windows上可能需要更新MTP驱动
5. 在Switch上按B键停止，再按X键重新启动服务

### Q: 传输速度很慢
**A:** 优化建议：
- 使用USB 3.0或更高版本端口
- 使用支持高速传输的USB-C数据线
- 关闭Switch上其他正在运行的程序
- 传输大文件时保持Switch电量充足

### Q: 传输过程中断开连接
**A:** 注意事项：
- 传输大文件时确保Switch不会进入休眠
- 保持USB连接稳定，不要移动Switch
- 传输完成前不要按B键停止服务

## 技术实现细节

### 架构说明
- **主程序**: main.cpp - 包含MTP初始化和主循环逻辑
- **文件系统代理**: 
  - `SdCardProxy` - 处理SD卡访问
  - `NandImageProxy` - 处理NAND分区访问
- **MTP库**: libhaze - 实现MTP协议通信

### 关键技术点
1. **线程管理**: MTP服务运行在独立线程（优先级0x20，核心2）
2. **互斥锁**: 使用mutex确保线程安全
3. **文件系统抽象**: 通过FileSystemProxyImpl接口统一不同存储设备的访问方式
4. **回调机制**: 实时监控MTP操作状态

### 代码结构
```
usbhs/
├── Makefile           # 编译配置
├── build.sh           # 编译脚本
├── README.md          # 英文说明
├── 项目说明.md         # 中文说明（本文件）
└── source/
    └── main.cpp       # 主程序源代码
```

## 安全提示

⚠️ **重要警告**：
- 使用Image nand功能时要格外小心，避免误删除系统文件
- 建议只使用microSD card功能进行日常文件传输
- 在修改或删除文件前请先备份重要数据
- 不要在MTP传输过程中强制断电或拔线

## 项目特点

### 优点
✅ 简单易用，按键即可启动/停止  
✅ 无需复杂配置，开箱即用  
✅ 支持同时访问SD卡和NAND分区  
✅ 传输稳定，支持大文件传输  
✅ 开源代码，可自由修改和定制  

### 限制
❌ 需要Homebrew环境支持  
❌ macOS需要第三方MTP软件  
❌ 传输速度受USB协议限制  
❌ 不支持后台运行  

## 后续开发计划

可能的功能扩展：
- [ ] 添加SD卡到NAND的镜像功能
- [ ] 支持更多存储分区
- [ ] 添加文件传输进度显示
- [ ] 实现传输速度优化
- [ ] 添加自动重连功能

## 许可协议

本项目基于原始libnx示例修改，遵循相关开源协议。

## 参考资料

- [libnx官方文档](https://github.com/switchbrew/libnx)
- [libhaze仓库](https://github.com/ITotalJustice/libhaze)
- [sphaira项目](https://github.com/ITotalJustice/sphaira)
- [DevkitPro官网](https://devkitpro.org/)
- [Switch Homebrew开发指南](https://switchbrew.org/)

## 致谢

感谢以下开源项目和开发者：
- **ITotalJustice** - libhaze和sphaira的作者
- **switchbrew团队** - libnx开发库
- **DevkitPro团队** - 开发工具链
- 所有为Switch homebrew生态做出贡献的开发者

## 联系方式

如有问题或建议，可以通过以下方式反馈：
- 提交GitHub Issue
- 参与Switch homebrew社区讨论

---

**最后更新**: 2025年11月
**版本**: 1.0
